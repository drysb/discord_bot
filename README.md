# Discord-Slack Relay Bot

A Python bot that relays Discord announcement messages to Slack channels in real-time.

# Purpose

This bot monitors specified Discord channels for announcement/crosspost messages and automatically forwards them to configured Slack webhooks. It's designed to keep your Slack workspace synchronized with important Discord announcements without requiring manual forwarding.

# Key Features

- Announcement Detection: Only forwards messages that are announcements (crossposted messages or messages with references)
- Duplicate Prevention: Built-in deduplication system prevents the same message from being posted multiple times
- Rate Limit Handling: Automatically handles Slack's rate limiting with exponential backoff
- Multi-Channel Support: Can relay from multiple Discord channels to different Slack webhooks
- Embed & Attachment Support: Forwards embeds and attachments from Discord messages

# Project Structure

### `discord_slack_bot.py`
The main bot implementation containing all core functionality:

- **Configuration Loading**: Reads environment variables for Discord/Slack credentials and channel mappings
- **RelayClient Class**: Discord bot client with async worker pattern
  - `on_message()`: Processes incoming Discord messages, filters announcements, and queues them
  - `_worker()`: Background task that processes the queue and sends messages to Slack
  - `_post_to_slack()`: Handles HTTP POST to Slack with retry logic
- **Helper Functions**:
  - `to_slack_md()`: Converts Discord markdown syntax to Slack's mrkdwn
  - `pick_webhook()`: Selects appropriate Slack webhook based on Discord channel
  - `clamp()`: Truncates long messages to prevent overflow

### `pyproject.toml`
Python project configuration file using modern PEP 621 standards:

- **Project Metadata**: Name, version, description, and author information
- **Dependencies**:
  - `discord-py>=2.4`: Discord API wrapper for Python
  - `aiohttp>=3.9`: Async HTTP client for Slack webhook calls
  - `python-dotenv>=1.0`: Environment variable management from `.env` files
- **Build System**: Configured for Poetry (Poetry Core 2.x)

### `poetry.lock`
Dependency lock file generated by Poetry:

- Ensures reproducible builds by locking exact versions of all dependencies
- Includes transitive dependencies (dependencies of dependencies)
- Should be committed to version control for consistent environments

### `.env`
Environment configuration file (not committed to version control):

Required variables:
- `DISCORD_TOKEN`: Your Discord bot token
- `CHANNEL_IDS`: Comma-separated Discord channel IDs to monitor
- `SLACK_WEBHOOK`: Default Slack webhook URL (if not using channel mapping)
- `SLACK_WEBHOOK_MAP`: JSON object mapping Discord channel IDs to Slack webhooks (optional)
- `MAX_MESSAGE_CHARS`: Maximum message length (0 for unlimited, optional)


# Setup & Installation

## Prerequisites

- Python 3.11 or higher
- Poetry (recommended) or pip
- Discord bot with appropriate permissions
- Slack incoming webhook(s)

## Installation Steps

1. **Clone the repository**:
   ```bash
   cd discord-slack-relay
   ```

2. **Install dependencies**:
   ```bash
   poetry install
   # or with pip:
   pip install discord-py aiohttp python-dotenv
   ```

3. **Configure environment variables**:
   Create a `.env` file in the project root with your credentials (see `.env` section above)

4. **Set up Discord bot**:
   - Go to [Discord Developer Portal](https://discord.com/developers/applications)
   - Create a new application and bot
   - Enable "Message Content Intent" in the Bot settings
   - Copy the bot token to your `.env` file
   - Invite the bot to your server with appropriate permissions (Read Messages, Read Message History)

5. **Set up Slack webhook**:
   - Go to your Slack workspace settings
   - Create an Incoming Webhook integration
   - Copy the webhook URL to your `.env` file

### Running the Bot

```bash
poetry run python discord_slack_bot.py
# or
python discord_slack_bot.py
```

You should see log output indicating the bot has logged in and is watching your configured channels.

## How It Works

1. **Bot starts** and connects to Discord using the provided token
2. **Monitors messages** in the configured `CHANNEL_IDS`
3. **Filters announcements** - only processes messages that are:
   - Crossposted (announcement) messages
   - Messages with references (replies/crossposts)
4. **Skips duplicates** using a 2000-message cache (approximately 15 minutes of history)
5. **Formats message** - converts Discord formatting to Slack format and adds metadata
6. **Queues for delivery** - adds message to async queue
7. **Worker processes queue** - sends to appropriate Slack webhook with rate limit handling
8. **Logs result** - records successful sends and any errors

## Logging

The bot provides detailed logging at INFO level:

- **Startup**: Bot login confirmation and watched channels
- **Skipped Messages**: `Skip Message: Not an Announcement (msg_id=..., author=...)`
- **Sent Messages**: `Sent Message to Slack (msg_id=..., author=...)`
- **Rate Limiting**: `Slack rate limited (429). Retrying in X.Xs`
- **Errors**: `Slack post failed: ...`

## Troubleshooting

### Bot doesn't start
- Verify `DISCORD_TOKEN` is correct
- Ensure `CHANNEL_IDS` contains valid channel IDs
- Check that either `SLACK_WEBHOOK` or `SLACK_WEBHOOK_MAP` is set

### Messages aren't being forwarded
- Confirm the bot has "Message Content Intent" enabled in Discord Developer Portal
- Verify the bot is in your Discord server and can see the channels
- Check that messages are announcements (crossposted) - regular messages are intentionally skipped
- Review logs for "Skip Message" entries explaining why messages were filtered

### Slack messages missing
- Check Slack webhook URL is correct and active
- Review error logs for HTTP status codes
- Ensure Slack workspace hasn't rate-limited your webhook

## License

This project is provided as-is for use in relaying Discord announcements to Slack.
